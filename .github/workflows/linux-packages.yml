# Linux packaging workflow - builds .deb and .rpm packages

name: Linux Packages

on:
  workflow_call:
  workflow_dispatch:

jobs:
  # Build .deb and .rpm packages for Linux
  build-linux-packages:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: amd64
            rpm_arch: x86_64
            runner: ubuntu-22.04
          - target: aarch64-unknown-linux-gnu
            arch: arm64
            rpm_arch: aarch64
            runner: ubuntu-22.04
    runs-on: ${{ matrix.runner }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # rust-toolchain.toml overrides the targets parameter above, so we need to explicitly add it
      - name: Add target
        run: rustup target add ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Install cargo-deb and cargo-generate-rpm
        run: |
          cargo install cargo-deb cargo-generate-rpm

      - name: Build release binary
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          fi
          cargo build --release --target ${{ matrix.target }}

      - name: Strip binary to reduce size
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            aarch64-linux-gnu-strip target/${{ matrix.target }}/release/fresh
          else
            strip target/${{ matrix.target }}/release/fresh
          fi
          ls -la target/${{ matrix.target }}/release/fresh

      - name: Setup target symlink for packaging
        run: |
          # cargo-deb/generate-rpm configs use paths relative to crate dir
          # Create symlink so target/release paths resolve to workspace target
          ln -s ../../target crates/fresh-editor/target

      - name: Build .deb package
        run: |
          cargo deb --no-build --target ${{ matrix.target }}

      - name: Build .rpm package
        working-directory: crates/fresh-editor
        run: |
          cargo generate-rpm --target ${{ matrix.target }}

      - name: Rename packages with architecture suffix
        run: |
          mkdir -p packages
          # Find and copy deb package
          find target/${{ matrix.target }}/debian -name "*.deb" -exec cp {} packages/ \;
          # Find and copy rpm package (symlink makes it end up in workspace target)
          find target/${{ matrix.target }}/generate-rpm -name "*.rpm" -exec cp {} packages/ \;
          ls -la packages/

      - name: Upload Linux packages
        uses: actions/upload-artifact@v6
        with:
          name: artifacts-linux-packages-${{ matrix.arch }}
          path: packages/*

  # Test .deb package installation on multiple Ubuntu versions
  test-deb-package:
    needs:
      - build-linux-packages
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu:22.04
            name: Ubuntu 22.04
          - distro: ubuntu:24.04
            name: Ubuntu 24.04
          - distro: debian:12
            name: Debian 12
    runs-on: ubuntu-22.04
    container:
      image: ${{ matrix.distro }}
    env:
      DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Download .deb package
        uses: actions/download-artifact@v7
        with:
          name: artifacts-linux-packages-amd64
          path: packages/

      - name: Install .deb package
        run: |
          apt-get update
          apt-get install -y ./packages/*.deb

      - name: Verify installation
        run: |
          echo "=== Testing on ${{ matrix.name }} ==="

          echo ""
          echo "=== Checking installed files ==="
          dpkg -L fresh-editor

          echo ""
          echo "=== Verifying binary location ==="
          ls -la /usr/share/fresh-editor/fresh
          test -x /usr/share/fresh-editor/fresh || { echo "Binary not executable"; exit 1; }

          echo ""
          echo "=== Verifying symlink ==="
          ls -la /usr/bin/fresh
          test -L /usr/bin/fresh || { echo "/usr/bin/fresh is not a symlink"; exit 1; }
          readlink /usr/bin/fresh | grep -q "/usr/share/fresh-editor/fresh" || { echo "Symlink points to wrong location"; exit 1; }

          echo ""
          echo "=== Testing binary via symlink ==="
          fresh --version
          /usr/bin/fresh --version
          /usr/share/fresh-editor/fresh --version

          echo ""
          echo "=== Checking plugins directory ==="
          ls -la /usr/share/fresh-editor/plugins/
          ls -la /usr/share/fresh-editor/plugins/lib/

          echo ""
          echo "=== Verifying binary and plugins are in same directory ==="
          test -f /usr/share/fresh-editor/fresh && test -d /usr/share/fresh-editor/plugins || { echo "Binary and plugins not in same dir"; exit 1; }

          echo ""
          echo "=== Testing uninstall ==="
          apt-get remove -y fresh-editor

          echo ""
          echo "=== Verifying symlink removed ==="
          test ! -e /usr/bin/fresh || { echo "Symlink not removed after uninstall"; exit 1; }

          echo ""
          echo "deb package test PASSED on ${{ matrix.name }}"

  # Test .rpm package installation on multiple Fedora/RHEL versions
  test-rpm-package:
    needs:
      - build-linux-packages
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: fedora:39
            name: Fedora 39
          - distro: fedora:40
            name: Fedora 40
          - distro: rockylinux:9
            name: Rocky Linux 9
    runs-on: ubuntu-22.04
    container:
      image: ${{ matrix.distro }}
    steps:
      - name: Download .rpm package
        uses: actions/download-artifact@v7
        with:
          name: artifacts-linux-packages-amd64
          path: packages/

      - name: Install .rpm package
        run: |
          dnf install -y packages/*.rpm

      - name: Verify installation
        run: |
          echo "=== Testing on ${{ matrix.name }} ==="

          echo ""
          echo "=== Checking installed files ==="
          rpm -ql fresh-editor

          echo ""
          echo "=== Verifying binary location ==="
          ls -la /usr/share/fresh-editor/fresh
          test -x /usr/share/fresh-editor/fresh || { echo "Binary not executable"; exit 1; }

          echo ""
          echo "=== Verifying wrapper script ==="
          ls -la /usr/bin/fresh
          test -x /usr/bin/fresh || { echo "/usr/bin/fresh is not executable"; exit 1; }
          head -1 /usr/bin/fresh | grep -q "#!/bin/sh" || { echo "/usr/bin/fresh is not a shell script"; exit 1; }

          echo ""
          echo "=== Testing binary via wrapper ==="
          fresh --version
          /usr/bin/fresh --version
          /usr/share/fresh-editor/fresh --version

          echo ""
          echo "=== Checking plugins directory ==="
          ls -la /usr/share/fresh-editor/plugins/
          ls -la /usr/share/fresh-editor/plugins/lib/

          echo ""
          echo "=== Verifying binary and plugins are in same directory ==="
          test -f /usr/share/fresh-editor/fresh && test -d /usr/share/fresh-editor/plugins || { echo "Binary and plugins not in same dir"; exit 1; }

          echo ""
          echo "=== Testing uninstall ==="
          dnf remove -y fresh-editor

          echo ""
          echo "=== Verifying wrapper removed ==="
          test ! -e /usr/bin/fresh || { echo "Wrapper not removed after uninstall"; exit 1; }

          echo ""
          echo "rpm package test PASSED on ${{ matrix.name }}"

  # Test .deb package upgrade from previous version
  test-deb-upgrade:
    needs:
      - build-linux-packages
    runs-on: ubuntu-22.04
    container:
      image: ubuntu:22.04
    env:
      DEBIAN_FRONTEND: noninteractive
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v6

      - name: Get version info
        id: version
        run: |
          # Get current version from Cargo.toml
          CURRENT_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "current=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Current version: $CURRENT_VERSION"

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y curl jq

      - name: Find and install previous version
        id: prev
        run: |
          # Get previous release version from GitHub
          PREV_VERSION=$(curl -s "https://api.github.com/repos/sinelaw/fresh/releases" | \
            jq -r '[.[] | select(.prerelease == false and .tag_name != "v${{ steps.version.outputs.current }}")] | .[0].tag_name' | \
            sed 's/^v//')

          if [ -z "$PREV_VERSION" ] || [ "$PREV_VERSION" = "null" ]; then
            echo "No previous release found, skipping upgrade test"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Previous version: $PREV_VERSION"
          echo "version=$PREV_VERSION" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"

          # Download and install previous version .deb package
          DEB_URL="https://github.com/sinelaw/fresh/releases/download/v${PREV_VERSION}/fresh-editor_${PREV_VERSION}-1_amd64.deb"
          echo "Downloading: $DEB_URL"
          curl -L -o /tmp/fresh-prev.deb "$DEB_URL" || {
            echo "Failed to download previous .deb, skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          }

          apt-get install -y /tmp/fresh-prev.deb

          # Verify previous version is installed
          INSTALLED=$(fresh --version)
          echo "Installed version: $INSTALLED"
          echo "$INSTALLED" | grep -q "$PREV_VERSION" || {
            echo "Warning: version mismatch, got $INSTALLED expected $PREV_VERSION"
          }

      - name: Download new .deb package
        if: steps.prev.outputs.skip != 'true'
        uses: actions/download-artifact@v7
        with:
          name: artifacts-linux-packages-amd64
          path: packages/

      - name: Upgrade to new version
        if: steps.prev.outputs.skip != 'true'
        run: |
          echo "=== Upgrading from v${{ steps.prev.outputs.version }} to v${{ steps.version.outputs.current }} ==="

          # Install (upgrade) to new version
          apt-get install -y ./packages/*.deb

          # Verify upgrade
          INSTALLED=$(fresh --version)
          echo "Installed version after upgrade: $INSTALLED"

          # Check version matches expected
          echo "$INSTALLED" | grep -q "${{ steps.version.outputs.current }}" || {
            echo "ERROR: Version mismatch after upgrade!"
            echo "Expected: ${{ steps.version.outputs.current }}"
            echo "Got: $INSTALLED"
            exit 1
          }

          echo ""
          echo "=== deb upgrade test PASSED ==="

  # Test .rpm package upgrade from previous version
  test-rpm-upgrade:
    needs:
      - build-linux-packages
    runs-on: ubuntu-22.04
    container:
      image: fedora:40
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v6

      - name: Get version info
        id: version
        run: |
          # Get current version from Cargo.toml
          CURRENT_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "current=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Current version: $CURRENT_VERSION"

      - name: Install dependencies
        run: |
          dnf install -y curl jq

      - name: Find and install previous version
        id: prev
        run: |
          # Get previous release version from GitHub
          PREV_VERSION=$(curl -s "https://api.github.com/repos/sinelaw/fresh/releases" | \
            jq -r '[.[] | select(.prerelease == false and .tag_name != "v${{ steps.version.outputs.current }}")] | .[0].tag_name' | \
            sed 's/^v//')

          if [ -z "$PREV_VERSION" ] || [ "$PREV_VERSION" = "null" ]; then
            echo "No previous release found, skipping upgrade test"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Previous version: $PREV_VERSION"
          echo "version=$PREV_VERSION" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"

          # Download and install previous version .rpm package
          RPM_URL="https://github.com/sinelaw/fresh/releases/download/v${PREV_VERSION}/fresh-editor-${PREV_VERSION}-1.x86_64.rpm"
          echo "Downloading: $RPM_URL"
          curl -L -o /tmp/fresh-prev.rpm "$RPM_URL" || {
            echo "Failed to download previous .rpm, skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          }

          dnf install -y /tmp/fresh-prev.rpm

          # Verify previous version is installed
          INSTALLED=$(fresh --version)
          echo "Installed version: $INSTALLED"
          echo "$INSTALLED" | grep -q "$PREV_VERSION" || {
            echo "Warning: version mismatch, got $INSTALLED expected $PREV_VERSION"
          }

      - name: Download new .rpm package
        if: steps.prev.outputs.skip != 'true'
        uses: actions/download-artifact@v7
        with:
          name: artifacts-linux-packages-amd64
          path: packages/

      - name: Upgrade to new version
        if: steps.prev.outputs.skip != 'true'
        run: |
          echo "=== Upgrading from v${{ steps.prev.outputs.version }} to v${{ steps.version.outputs.current }} ==="

          # Upgrade to new version using rpm -U
          rpm -U ./packages/*.rpm

          # Verify upgrade
          INSTALLED=$(fresh --version)
          echo "Installed version after upgrade: $INSTALLED"

          # Check version matches expected
          echo "$INSTALLED" | grep -q "${{ steps.version.outputs.current }}" || {
            echo "ERROR: Version mismatch after upgrade!"
            echo "Expected: ${{ steps.version.outputs.current }}"
            echo "Got: $INSTALLED"
            exit 1
          }

          echo ""
          echo "=== rpm upgrade test PASSED ==="

  # Final job that depends on all tests to ensure failures propagate to caller
  # This job will fail if any dependent job fails, causing the reusable workflow to fail
  linux-packages-complete:
    needs: [build-linux-packages, test-deb-package, test-rpm-package, test-deb-upgrade, test-rpm-upgrade]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-22.04
    steps:
      - name: Check all jobs succeeded
        if: ${{ failure() || contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}
        run: |
          echo "One or more jobs failed:"
          echo "  build-linux-packages: ${{ needs.build-linux-packages.result }}"
          echo "  test-deb-package: ${{ needs.test-deb-package.result }}"
          echo "  test-rpm-package: ${{ needs.test-rpm-package.result }}"
          echo "  test-deb-upgrade: ${{ needs.test-deb-upgrade.result }}"
          echo "  test-rpm-upgrade: ${{ needs.test-rpm-upgrade.result }}"
          exit 1
      - name: All jobs succeeded
        run: echo "All linux package jobs succeeded!"
